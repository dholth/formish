<%namespace name="formish" file="formish/Form.html" />
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta content="text/html; charset=UTF-8" http-equiv="content-type" />
  <meta name="description" value="" />
  <meta name="keywords" value="" />
  <title>${self.title()}</title>
  <link href="/css/forms.css" type="text/css" rel="stylesheet" />
  <script src="/js/jquery-1.2.6.min.js" type="text/javascript"></script>
  <script src="/js/jquery.base64.js" type="text/javascript"></script>
  <script type="text/javascript">
   //<![CDATA[


function count_previous_fields(o) {
  var f = o.prevAll('.field').length;
  var g = o.prevAll('.group').length;
  if (f > g) {
    return f;
  } else {
    return g;
  };
};   
   
function create_addlinks(o) {
  o.find('.adder').each(function() {
    $(this).before('<a class="adderlink">Add</a>');
  });
};

function get_sequence_numbers(segments, l) {
  var result = Array();
  for each (segment in segments) {
    if (isNaN(parseInt(segment)) == false) {
      result.push(segment);
    }
  }
  result.push(l);
  console.log('built seqnums '+result);
  return result
}

function replace_stars(original, nums, divider) {
  var result = Array();
  console.log('original '+original+' ; seqnums = '+seqnums);
  var segments = original.split(divider);
  console.log('segments '+segments);
  n = 0;

  for each (segment in segments) {
    console.log('checking '+segment);
    if (segment == '*' && n < nums.length)   {
      //console.log('pushing num '+segment);
      result.push(nums[n]);
      n=n+1;
    } else {
      //console.log('pushing segment '+segment);
      result.push(segment);
    }
  }
  return result.join(divider);
}


function add_mousedown_to_addlinks(o) {
  o.find('.adderlink').mousedown( function() {
    // Get the base64 encoded template
    var code = $(this).next('.adder').val();
    // Find out how many fields we already have
    var l = count_previous_fields($(this).next('.adder'));
    // Get some variable to help with replacing (originalname, originalid, name, id)
    var originalname = $(this).next('.adder').attr('name');
    var segments = originalname.split('.');
    // Get the numbers used in the originalname
    seqnums = get_sequence_numbers(segments, l);
    var originalid = $(o).attr('id')+'-'+segments.join('-');
    segments[ segments.length -1 ] = l;
    var name = segments.join('.');
    var id = $(o).attr('id')+'-'+segments.join('-');
    //console.log('id = '+id+' ; name = '+name);
    // Decode the base64
    var html = $.base64Decode(code);
    // Add the links and mousedowns to this generated code
    var h = $(html);
    create_addlinks(h);
    add_mousedown_to_addlinks(h);

    h.find("[name]").each( function () {
      console.log('tan '+$(this).attr('name'));
      var newname = replace_stars($(this).attr('name'), seqnums, '.');
      $(this).attr('name', newname );
    });
    
    //h.find("[name^='"+originalname+"']").each( function () {
    //  var newname = $(this).attr('name').replace(originalname, name);
    //  $(this).attr('name', newname );
    //});
    var newid = replace_stars(h.attr('id'),seqnums,'-')

    h.attr('id',newid);
    h.find("[id]").each( function () {
      var newid = replace_stars($(this).attr('id'),seqnums, '-');
      console.log('###',$(this).attr('id'), newid)
      $(this).attr('id', newid );
    });
    h.find("[for]").each( function () {
      var newid = replace_stars($(this).attr('for'),seqnums, '-');
      $(this).attr('for', newid );
      if ($(this).text() == '*') {
        $(this).text(l);
      }
    });
    h.find("label[for='"+id+"']").text(l);
    h.find("legend:contains('*')").text(l);

    $(this).before(h);
  });
};

   
$(document).ready(function() {
    create_addlinks($('form'));
    add_mousedown_to_addlinks($('form'));
})
   //]]>
  </script>
</head>

<body class="">
<div id="header">
  <h1>Formish</h1>
</div>
<div id="body">
  ${self.body()}
</div>


<div id="footer">
  &copy; <strong class="infomy">Tim and Matt</strong> 
</div>

</body>
</html>

<%def name="title()">
% if hasattr(self, 'page_title'):
  ${self.page_title()} @ infomy
% else:
  infomy
% endif
</%def>



